<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weird-Dream.com</title>

  <style>
    :root { --text-light: #ffffff; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: "Aptos Serif", Georgia, "Times New Roman", serif;
      background: url('/dream.jpg') center/cover no-repeat;
      color: var(--text-light);
      display: flex; align-items: center; justify-content: center;
      text-align: center; min-height: 100vh; padding: 2rem;
    }
    .container {
      max-width: 640px; width:100%;
      opacity: 0; animation: fadeIn 1.2s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(10px); }
      to   { opacity:1; transform: translateY(0); }
    }
    .cta-btn {
      background: rgb(175,199,239);
      color: #fff;
      font-family: inherit;
      padding: .9rem 2.2rem;
      border: none; border-radius: 2rem;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
      box-shadow: 0 6px 20px rgba(175,199,239,.4);
    }
    .cta-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(175,199,239,.6);
    }
    .cta-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(175,199,239,.35);
    }
    textarea { width:100%; font-family:inherit; padding:.5rem; margin-bottom:.5rem; }
    canvas { margin-top: 3rem; }
    #statusMsg { margin-top:1rem; font-size:.95rem; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.1.2/src/wordcloud2.min.js"></script>
</head>
<body>
  <div class="container">
    <img src="/DreamLogo1.png" alt="Weird Dream Logo"
         style="max-width:60%;height:auto;margin-bottom:1rem;" />
    <p>Did you have an unusually vivid dream last night? Summarise your experience with a few key words or concepts...</p>
    <textarea id="dreamKeywords" rows="2"
      placeholder="e.g. flying, falling, talking catâ€¦"></textarea>

    <button id="submitBtn" class="cta-btn">Submit Dream & Keywords</button>
    <p id="statusMsg"></p>

    <canvas id="dreamChart" width="400" height="160"></canvas>
    <canvas id="wordCloudCanvas" width="400" height="200"></canvas>
  </div>

  <script>
    const submitBtn = document.getElementById("submitBtn");
    const keywordsBox = document.getElementById("dreamKeywords");
    const statusMsg  = document.getElementById("statusMsg");
    const chartCtx   = document.getElementById("dreamChart").getContext("2d");
    const cloudCanvas = document.getElementById("wordCloudCanvas");
    let dreamChart;

    const STOPWORDS = new Set(["the","and","for","with","that","this","was","last","night","a","i","to","of","in"]);
    function getWordFreqList(texts) {
      const freq = {};
      texts.forEach(phrase => {
        phrase.split(/\W+/).forEach(w => {
          const wlc = w.toLowerCase();
          if (wlc.length < 3 || STOPWORDS.has(wlc)) return;
          freq[wlc] = (freq[wlc] || 0) + 1;
        });
      });
      return Object.entries(freq);
    }

    async function showWordCloud(date) {
      const ctx = cloudCanvas.getContext("2d");
      ctx.clearRect(0, 0, cloudCanvas.width, cloudCanvas.height);
      try {
        const res = await fetch(`/dream-texts?date=${date}`);
        if (!res.ok) return;
        const texts = await res.json();
        const list = getWordFreqList(texts);
        if (!list.length) {
          ctx.fillStyle = "#fff";
          ctx.font = "16px Aptos Serif, Georgia, serif";
          ctx.fillText("No keywords for " + new Date(date).toLocaleDateString('en-GB',{month:'long',day:'numeric'}), 10, 20);
          return;
        }
        WordCloud(cloudCanvas, {
          list,
          gridSize: 18,
          weightFactor: w => w * 8,
          backgroundColor: "transparent",
          color: "#fff",
          fontFamily: '"Aptos Serif", Georgia, serif'
        });
      } catch (e) { console.error(e); }
    }

    async function fetchStats() {
      try {
        const res = await fetch("/dream-stats");
        if (!res.ok) throw new Error();
        const data = await res.json();
        updateChart(data);
      } catch (e) { console.error(e); }
    }

    function updateChart(data) {
      const labels = data.map(d=>d.date);
      const counts = data.map(d=>d.count);
      if (dreamChart) {
        dreamChart.data.labels   = labels;
        dreamChart.data.datasets[0].data = counts;
        dreamChart.update();
        return;
      }
      dreamChart = new Chart(chartCtx, {
        type: "bar",
        data: { labels, datasets:[{ label: "Weird Dreams per Day", data: counts,
          backgroundColor:"rgba(175,199,239,.9)", borderColor:"rgba(175,199,239,1)", borderWidth:1 }]
        },
        options: {
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            const date = dreamChart.data.labels[idx];
            showWordCloud(date);
          },
          scales: {
            x: { ticks:{ color:"#cccccc", font:{family:'"Aptos Serif",Georgia,"Times New Roman",serif'},
                  maxTicksLimit:12, autoSkip:true,
                  callback(v){ const d=new Date(this.getLabelForValue(v)); return d.toLocaleDateString('en-GB',{month:'long',day:'numeric'}); }
            }},
            y: { beginAtZero:true, ticks:{ precision:0, color:"#cccccc", font:{family:'"Aptos Serif",Georgia,"Times New Roman",serif'} } }
          },
          plugins: { legend:{ labels:{ color:"#cccccc", font:{family:'"Aptos Serif",Georgia,"Times New Roman",serif'} } } }
        }
      });
    }

    async function submitAll() {
  const keywords = keywordsBox.value.trim();
  if (!keywords) {
    statusMsg.textContent = "Please enter some keywords.";
    return;
  }

  try {
    // 1) record the dream count
    let res = await fetch("/dream", { method: "POST" });
    const json1 = await res.json();
    if (!res.ok) {
      statusMsg.textContent = json1.message || "Error recording dream.";
      return;
    }

    // 2) record the keywords
    res = await fetch("/dream-text", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ dreamText: keywords })
    });
    const json2 = await res.json();
    if (!res.ok) {
      statusMsg.textContent = json2.message || "Error recording keywords.";
      return;
    }

    // 3) success
    statusMsg.textContent = json2.message || "Recorded!";
    keywordsBox.value = "";
    fetchStats();
  } catch (err) {
    statusMsg.textContent = "Error submitting dream.";
    console.error(err);
  }
}

    submitBtn.addEventListener("click", submitAll);
    window.addEventListener("DOMContentLoaded", fetchStats);
  </script>
</body>
</html>
